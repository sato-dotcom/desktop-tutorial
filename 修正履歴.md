## 導入文

このページでは、海洋版測量支援アプリ「うみねこ」の開発における技術検証とAI連携の履歴を記録・整理しています。ここでは、検証、修正の履歴を残していきます。CopilotやGeminiなどのAIツールを活用し、各フェーズでの検証内容や改善提案を体系的にまとめています。

## 役割分担（人間とAI）

| 担当 | 役職 | 役割 |
| --- | --- | --- |
| Akinori（人間） | 責任者 | 現場検証、課題発見、仕様判断、フィードバック |
| ChatGPT（AI） | 技術顧問 | 初期検証支援、コード生成、技術的なアイデア出し |
| Copilot（AI） | 開発ディレクター | コードレビュー、修正提案、履歴整理、構成支援 |
| Gemini（AI） | 実装エンジニア | 表示挙動の安定化、センサー処理、補正ロジックの提案と実装 |

### コメント欄からのAI連携履歴要約

- 導入文の目的明確化：「検証、修正の履歴を残していきます」の一文追加（Copilot）
    
- コメント欄のやり取りを履歴として記録する方針（人間）
    
- スレッド引継ぎのための履歴整理の重要性（人間）
    
- 同じ修正・失敗の繰り返しを防ぐための履歴蓄積（人間）
    
- 引き継ぐAIが理解しやすいように要約・整理する必要性（人間）
    

## 試したこと（技術検証ログ）

- [`map.once`](https://map.once/)`('resize')` によるマーカー再描画のタイミング調整
    
- `requestAnimationFrame` を用いた描画安定化の試行
    
- `updateMapView(true)` によるマーカー位置補正の効果検証
    
- GPS更新とUIイベントの連携検証（効果なし）
    
- `panBy` による中央補正の試行（成功率低め）
    
- resize完了後の処理順序見直し
    
- UI側のフラグ制御による表示安定化
    
- 全画面切替時のマーカー位置再検討
    
- Heading-up表示の安定化案（方位センサーにフィルター適用）
    
- スマホとPCでの挙動差の記録と比較
    
- Geminiへの修正要望（全画面補正・初期表示・回転安定化）
    

## フェーズ分類

### フェーズ1：初期検証と基本機能の安定化

- 地図表示と現在地マーカーの挙動確認
    
- 全画面切替時のマーカー位置調整
    
- [`map.once`](https://map.once/)`('resize')` による再描画タイミングの検証
    

### フェーズ2：描画安定化とUI改善

- `requestAnimationFrame` を用いた描画安定化の試行
    
- `updateMapView(true)` によるマーカー位置補正
    
- Heading-up表示のUI調整と安定化
    

## ラベル運用ルール（検証日時別履歴表）

| ラベル | 意味 | 備考 |
| --- | --- | --- |
| 【成果あり】 | 検証・修正を実行し、何らかの挙動変化やログ出力が確認された | 効果の有無は別途記録で判断 |
| 【効果あり】 | 実行結果として、目的とした不具合が解消された | 明確な改善が確認できた場合に使用 |
| 【効果なし】 | 実行したが、期待した改善が見られなかった | 次の修正方針の検討材料になる |
| 【暫定成果】 | 一部改善が見られたが、安定性や再現性に課題が残る | 継続検証が必要な場合に使用 |
| 【要再修正】 | 修正後に新たな不具合が発生した、または既存の問題が残った | Gemini等への再依頼が必要な状態 |

## 検証日時別履歴表

※ 同じ日に複数の検証を行う場合は、必要に応じて同一日付内で振り番号を付けて記録します。

### 2025/09/01

- 地図表示と現在地マーカーの初期挙動確認（Copilot）【成果あり】
    
- 全画面切替後のマーカー位置ズレを記録（Copilot）【成果あり】
    

### 2025/09/02

- [`map.once`](https://map.once/)`('resize')` による再描画タイミング調整（Copilot）【成果あり】
    
- `requestAnimationFrame` による描画安定化の試行（Copilot）【成果あり】
    

### 2025/09/03

- `updateMapView(true)` によるマーカー位置補正の効果検証（Copilot）【成果あり】
    
- Geminiへの修正要望（全画面補正・初期表示・回転安定化）（Gemini）【成果あり】
    

### 2025/09/04

- GPS更新とUIイベントの連携検証（Copilot）【効果なし】
    
- `panBy` による中央補正の試行（Copilot）【効果限定】
    

### 2025/09/05

- resize完了後の処理順序見直し（Copilot）【成果あり】
    
- UI側のフラグ制御による表示安定化（Copilot）【成果あり】
    

### 2025/09/06

- Heading-up表示の安定化案（方位センサーにフィルター適用）（Gemini）【成果あり】
    
- スマホとPCでの挙動差の記録と比較（Copilot）【成果あり】
    

### 2025/09/07

- Geminiによる `recenterAbsolutely()` の補正ロジック強化（Gemini）【成果あり】
    
- `getBoundingClientRect()` によるズレ量の動的取得（Gemini）【成果あり】
    

### 2025/09/08

- 追従マークの初期表示色の同期（青色ON状態）（Copilot）【成果あり】
    
- `toggleFollowUser(true)` の初期化処理への組み込み（Copilot）【成果あり】
    

### 2025/09/09

- ヘディングアップ時のマーカー回転安定化（低域通過フィルター＋閾値）（Gemini）【暫定成果】
    
- 地図は回さずマーカーのみ回転（フェーズ1仕様）（Gemini）【暫定成果】
    

### 2025/09/10

- ログ出力強化（deltaY補正量、追従状態、GPS更新時の挙動）（Copilot）【成果あり】
    

### 2025/09/11

- 「試したこと」と「AI連携履歴」の分離提案と新ページ構成（Copilot）【成果あり】
    
- 履歴表の検証日時別整理とフェーズ分類の検討（Copilot）【成果あり】
    

### 2025/09/11-2

- コメント欄のやり取り（スマホとPCの挙動差の詳細記録）（人間）【成果あり】
    
- Geminiへの修正要望文の拡張（スマホ/PC差の吸収を追加）（Copilot）【成果あり】
    
- Geminiによる修正実装（recenterAbsolutely刷新、UI初期表示同期、方位センサー安定化、ログ強化）（Gemini）【成果あり】
    
- 修正後の新たな不具合：GPSが反映されなくなった、全画面切替アイコンが消失（人間）【要再修正】
    

### 2025/09/12

- Geminiへの修正要望（GPS復活・全画面切替復活・追従UI修正）（Copilot）【成果あり】
    
- Geminiによる修正実装（[main.js](https://main.js/), [gps.js](https://gps.js/), [mapController.js](https://mapcontroller.js/), [ui.js](https://ui.js/), input.css）（Gemini）【成果あり】
    
- PCでの挙動確認（全画面切替後のマーカー位置、追従切替時のログ出力、UI色変化なし）（人間）【暫定成果】
    
- スマホでの挙動確認（マーカー位置の変動、ヘディングアップ時の回転不安定、UI色変化なし）（人間）【暫定成果】
    

### 2025/09/12-2

- Geminiへの修正要望（全画面補正再強化・UI色同期修正・回転安定化）（Copilot）【成果あり】
    
- Geminiによる修正実装（[mapController.js](https://mapcontroller.js/), [gps.js](https://gps.js/), [ui.js](https://ui.js/), input.css）（Gemini）【成果あり】
    
- PCでの挙動確認（全画面ON/OFF後のマーカー位置、追従切替時の色変化、回転挙動）（人間）【暫定成果】
    
- スマホでの挙動確認（全画面ON/OFF後のマーカー位置、回転方向の不一致、激しい回転）（人間）【暫定成果】
    
- 追加要望：小刻みな揺れは許容、大きな揺れは抑制／回転方向のアニメーション制御（人間）【要再修正】
    

### 2025/09/16

- Gemini修正後の回転挙動に対するフィードバック（人間）【成果あり】
    
    - 小刻みな揺れ（1度程度）は許容、大きな揺れ（90°〜180°）は抑制希望
        
    - 回転アニメーションの方向が逆転する問題（左回り→右回り355°）の修正要望
        
- 全画面表示の挙動確認（マーカーが中央に表示される）（人間）【効果あり】
    

### 2025/09/16-2

- Geminiへの修正要望（回転安定化ロジックの統合）（Copilot）【成果あり】
    
- Geminiによる修正実装（[gps.js](https://gps.js/), mapController.js）（Gemini）【成果あり】
    
    - gps.js: 方位センサー処理（onCompassUpdate）を改善版に差し替え、スパイク除去と滑らかな方位出力を実現
        
    - mapController.js: updateMapRotation関数を改善版に差し替え、最短方向への滑らかな回転を実装
        
- PCでの挙動確認（全画面切替、ヘディングアップ切替、回転挙動）（人間）【暫定成果】
    
    - 全画面切替、GPS更新、UI同期は安定版に準じて復活
        
    - 回転挙動は大方安定、左右回転は改善されたが、まれに360°回転アニメーションが発生
        
    - 回転方向の計算タイミングに課題が残る可能性あり
        

• Gemini修正後の回転挙動に対するフィードバック（人間確認）【成果あり】

• 小刻みな揺れ（1度程度）は許容、大きな揺れ（90°〜180°）は抑制希望

• 回転アニメーションの方向が逆転する問題（左回り→右回り355°）の修正要望

• 全画面表示の挙動確認（マーカーが中央に表示される）（人間確認）【効果あり】

### 2025/09/16-4

- Copilot(Smart)による現状まとめ（人間→Copilot）【成果あり】
    
    - 安定版の状態（全画面切替、GPS更新、UI同期、回転挙動）を整理
        
    - 直近の修正履歴（toggleHeadingUp, updateMapRotation）を明記
        
    - 現状の課題（カクつき、補間速度、閾値調整）を記録
        
    - 次の依頼方針（スキップ拡張、差分継続判定、補間速度調整、挙動比較ログ）を提示
        
    - 注意事項として「安定版の基本機能は変更不可」「修正対象は限定」と明記
        

### 2025/09/17

- Copilot(Smart)による現状まとめ（人間→Copilot）【成果あり】
    
    - DrawnAngle と Heading(TN) の同期化：[mapController.js](https://mapcontroller.js/) の回転処理を currentHeading 参照に統一し、同期ズレを解消。ただし「進行方向にスマホを向けたときの大回転」は残存
        
    - MapRotation のデバッグ表示追加：[state.js](https://state.js/) に mapRotationAngle を追加し、[gps.js](https://gps.js/) のデバッグパネルに表示。地図は固定で原因はマーカー側と確定
        
    - マーカー回転の最短補間処理追加：[mapController.js](https://mapcontroller.js/) に最短回転補間ロジックを導入するも、大回転は依然発生
        
    - 差分ログ化による原因切り分け：target / last / diff の詳細ログ出力を追加し、差分が大きくなる瞬間を確認
        
    - course 値と rawHeading の詳細ログ追加：[state.js](https://state.js/) に lastRawHeading を追加し、[gps.js](https://gps.js/) で更新。[mapController.js](https://mapcontroller.js/) で course と raw を含む詳細ログを出力。解析スクリプトでログを精査
        
    - ログ解析結果：rawHeading が ±300°級でジャンプし、course 値は変化していない → 原因はコンパス生値の境界跨ぎスパイクと特定
        
    - 次の対策案：[gps.js](https://gps.js/) に境界補正＋スパイク除去フィルタ（例：1フレームで 45°以上の変化は無視）を追加予定。Geminiへの依頼時にエラー発生 → スレッド更新のタイミング
        

• Copilot(Smart)による現状まとめ（人間→Copilot）【成果あり】

• 安定版の状態（全画面切替、GPS更新、UI同期、回転挙動）を整理

• 直近の修正履歴（toggleHeadingUp, updateMapRotation）を明記

• 現状の課題（カクつき、補間速度、閾値調整）を記録

• 次の依頼方針（スキップ拡張、差分継続判定、補間速度調整、挙動比較ログ）を提示

• 注意事項として「安定版の基本機能は変更不可」「修正対象は限定」と明記

### 2025/09/17-2

• 前回更新以降の経緯まとめ（人間）【成果あり】

• DrawnAngle と Heading(TN) の同期化（mapController.js）

• MapRotation 表示追加（[state.js](https://state.js/), gps.js）→ 地図は固定、原因はマーカー側

• 最短補間処理追加（mapController.js）→ 大回転は残存

• 差分ログ化（target / last / diff）→ 大差分の瞬間を確認

• course / rawHeading のログ追加と解析スクリプト作成

• 原因特定：rawHeading の ±300°ジャンプ → コンパス生値の境界跨ぎスパイク

• 次の対策：[gps.js](https://gps.js/) に境界補正＋スパイク除去フィルタを追加予定（Gemini依頼時にエラー発生）

### 2025/09/24

- 修正履歴（前回スレッド更新以降）（人間）【成果あり】
    
    - mapRotationAngle のログ追加 → 地図回転とマーカー回転の二重適用の可能性を検証
        
    - 相対角度方式への切り替え → 挙動が逆転（ノースアップで回転、ヘディングアップで固定）
        
    - モード逆転修正 → 挙動は仕様通りに戻るが、大回転は残存
        
    - 大ジャンプ時の強制同期処理 → SYNCログ出力されるも、大回転は残存
        
    - 相対角度方式の再導入 → 再び逆転挙動が発生
        
    - モード逆転修正＋初期化改善 → 挙動は正しくなるが、起動直後の方角未反映問題が残存
        
    - 大回転対策＋初期化改善（最新版） → `updateMapRotation()` の強制呼び出しを追加するも、大回転と未反映は残存
        
- 現在の状況（人間）【成果あり】
    
    - モード挙動は仕様通りに整理済み（ノースアップ＝固定／ヘディングアップ＝回転）
        
    - 残課題：①進行方向を向いた瞬間の大回転、②起動直後に方角が反映されない
        
    - 次の一手：初期化イベントの強制呼び出し実装と、相対角度の適用位置の再確認
        

### 2025/09/25

- マーカー回転挙動の再修正依頼（人間）【成果あり】
    
    - ノースアップ／ヘディングアップの挙動が逆転していた
        
    - 起動直後に方角が反映されない
        
    - ヘディングアップ時に「大回転」が発生
        
    - ノースアップ時はマーカー北固定、ヘディングアップ時は端末の進行方向に回転、初期化処理で NaN を防止、スパイク除去ロジックを維持
        
- 復旧優先の再々修正依頼（人間）【成果あり】
    
    - 修正後、アプリが動かなくなり GPS/方角が反映されない
        
    - 起動直後は依然として方角が反映されず、地図切替ボタンで初めて反映
        
    - イベント配線を復活、初期化フレームを必ず通す、スパイク除去は初期値を飲み込まないように修正、ログ強化
        
- 完全復旧テストと配線修理（人間）【成果あり】
    
    - GPS/方角が依然として反映されず、イベントが呼ばれているか不明
        
    - イベント配線の可視化（\[DEBUG-WIRE\], \[DEBUG-EVT\]）、初期化強制適用、ハートビート導入、DOM適用の健全性チェック、疑似適用モードで強制回転確認
        
- ヘディングアップ時の不安定回転修正（人間）【成果あり】
    
    - GPSは反映されるようになったが、ヘディングアップ時に「だいたい北を向く」「突然一回転」する挙動
        
    - デバッグUIが最下部に4行のみ表示され、情報不足
        
    - 相対角を -180°〜+180°に正規化、最短経路で補間（LERP）、transform の累積を避け rotate のみ上書き、DOM適用先を `.user-location-marker-rotator` に固定、デバッグUIを10〜20行表示、スクロール可能、更新頻度2Hzに制御
        
- スマホ起動時の「開始ボタン」問題（人間）【成果あり】
    
    - 起動直後に「センサー利用の許可」オーバーレイ＋開始ボタンが出るが、押しても進まない
        
    - 実際には「起動直後に反映されない」のはブラウザ仕様
        
    - オーバーレイと開始ボタンを削除、起動直後は「測位中」で待機、ユーザー操作で反映開始、仕様としてマニュアルに記載
        
- 現在の状態（人間）【暫定成果】
    
    - GPS情報: 反映される
        
    - ノースアップ: マーカー北固定（仕様通り）
        
    - ヘディングアップ: 相対角で回転するが、まだ安定性に課題（数値がせわしなく変動）
        
    - UI: デバッグウィンドウは表示されているが、行数や更新頻度の改善が必要
        
    - スマホ起動: 起動直後は測位中、地図切替などの操作で反映開始（仕様として割り切り）